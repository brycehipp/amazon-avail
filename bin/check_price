#!/usr/bin/env node

var pg = require('pg'),
    request = require('request'),
    cheerio = require('cheerio'),
    colors = require( 'colors' ),
    console = require('better-console');

var sendgrid  = require('sendgrid')(
  process.env.SENDGRID_USERNAME,
  process.env.SENDGRID_PASSWORD
);

process.stdout.write( '\n=====>\tScrape started!\n' );

var i = 0,
    products = [
      {
        'name': 'Merth',
        'url' : 'http://amzn.com/B00N4ABOXU'
      },
      {
        'name': 'Villager',
        'url' : 'http://amzn.com/B00N4ABMUA'
      },
      {
        'name': 'WFT',
        'url' : 'http://amzn.com/B00N49EERY'
      }
    ];

function lookupProduct ( product ) {
  i++;

  if ( i <= products.length ) {

    process.stdout.write( '\t'+product.name+':\r' );

    request.get( product.url, function(error, response, html) {

      // First we'll check to make sure no errors occurred when making the request
      if ( !error ) {

        var $ = cheerio.load( html );

        // Attempt to grab the price of the product. Will be 0 if not found.
        var price = Number( $('#actualPriceValue').text().replace(/[^0-9\.]+/g,"") ),
            isFound = price > 0 && price < 13,
            foundText = isFound ? String('FOUND!').green.bold : '';

        process.stdout.write( '\t'+product.name+':  '+String('$'+price).blue.bold+'\t'+foundText+'\n' );

        if ( isFound ) {
          sendgrid.send({
            to: ['stiffhipp@gmail.com', 'michael.klodzinski@gmail.com'],
            from: 'amiibo.finder@amazon-avail.herokuapp.com',
            subject: '[Amazon Avail] Found '+product.name,
            text: product.name+' has been found for '+price+'!\n\n<a href="'+product.url+'">GET NOW!</a>'
          }, function( err, json ) {
            if ( err ) {
              console.error( err );
            }
          });
        }

      } else {
        console.error( '\tError looking up'+product.name );
        console.error( error );
      }

      lookupProduct( products[i] );
    } );
  } else {
    process.stdout.write( '=====>\tScrape completed!\n' );
  }
};

lookupProduct( products[0] );
